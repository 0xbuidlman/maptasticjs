/*! maptastic 2014-12-07 */
!function(){function a(b,c,d,e){if(d===c.length-1)return e(b);var f,g=c[d],h=Array(g);for(f=g-1;f>=0;--f)h[f]=a(b[f],c,d+1,e);return h}function b(a){for(var b=[];"object"==typeof a;)b.push(a.length),a=a[0];return b}function c(a){var c,d;return"object"==typeof a?(c=a[0],"object"==typeof c?(d=c[0],"object"==typeof d?b(a):[a.length,c.length]):[a.length]):[]}function d(a){var b,c=a.length,d=Array(c);for(b=c-1;-1!==b;--b)d[b]=a[b];return d}function e(b){return"object"!=typeof b?b:a(b,c(b),0,d)}function f(a,b){b=b||!1;var c,d,f,g,i,j,k,l,m,n=a.length,o=n-1,p=new Array(n);for(b||(a=e(a)),f=0;n>f;++f){for(k=f,j=a[f],m=h(j[f]),d=f+1;n>d;++d)g=h(a[d][f]),g>m&&(m=g,k=d);for(p[f]=k,k!=f&&(a[f]=a[k],a[k]=j,j=a[f]),i=j[f],c=f+1;n>c;++c)a[c][f]/=i;for(c=f+1;n>c;++c){for(l=a[c],d=f+1;o>d;++d)l[d]-=l[f]*j[d],++d,l[d]-=l[f]*j[d];d===o&&(l[d]-=l[f]*j[d])}}return{LU:a,P:p}}function g(a,b){var c,d,f,g,h,i=a.LU,j=i.length,k=e(b),l=a.P;for(c=j-1;-1!==c;--c)k[c]=b[c];for(c=0;j>c;++c)for(f=l[c],l[c]!==c&&(h=k[c],k[c]=k[f],k[f]=h),g=i[c],d=0;c>d;++d)k[c]-=k[d]*g[d];for(c=j-1;c>=0;--c){for(g=i[c],d=c+1;j>d;++d)k[c]-=k[d]*g[d];k[c]/=g[c]}return k}var h=Math.abs;solve=function(a,b,c){return g(f(a,c),b)}}();var Maptastic=function(a){var b=function(a,b,c){return a&&a.hasOwnProperty(b)?a[b]:c},c=b(a,"showLayerNames",!0),d=b(a,"crosshairs",!1),e=b(a,"autoSave",!0),f=b(a,"layers",[]),g=b(a,"onchange",function(){}),h="maptastic.layers",i=null,j=null,k=[],l=!1,m=!1,n=[],o=null,p=null,q=20,r=null,s=null,t=[],u=[],v=function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))},w=function(a,b,c,d){var e=b[1]*d[0]-b[0]*d[1]+(d[1]-b[1])*a[0]+(b[0]-d[0])*a[1],f=b[0]*c[1]-b[1]*c[0]+(b[1]-c[1])*a[0]+(c[0]-b[0])*a[1];if(0>e!=0>f)return!1;var g=-c[1]*d[0]+b[1]*(d[0]-c[0])+b[0]*(c[1]-d[1])+c[0]*d[1];return 0>g&&(e=-e,f=-f,g=-g),e>0&&f>0&&g>e+f},x=function(a,b){var c=w(a,b.targetPoints[0],b.targetPoints[1],b.targetPoints[2]),d=w(a,b.targetPoints[3],b.targetPoints[0],b.targetPoints[2]);return c||d},y=function(){g()},z=function(){if(l){j.strokeStyle="red",j.lineWidth=2,j.clearRect(0,0,i.width,i.height);for(var a=0;a<k.length;a++){j.beginPath(),j.strokeStyle=k[a]===s?"red":k[a]===o?"red":"white",j.moveTo(k[a].targetPoints[0][0],k[a].targetPoints[0][1]);for(var b=0;b<k[a].targetPoints.length;b++)j.lineTo(k[a].targetPoints[b][0],k[a].targetPoints[b][1]);j.lineTo(k[a].targetPoints[3][0],k[a].targetPoints[3][1]),j.closePath(),j.stroke();for(var e=[0,0],b=0;b<k[a].targetPoints.length;b++)j.strokeStyle=k[a].targetPoints[b]===r?"red":k[a].targetPoints[b]===p?"red":"white",e[0]+=k[a].targetPoints[b][0],e[1]+=k[a].targetPoints[b][1],j.beginPath(),j.arc(k[a].targetPoints[b][0],k[a].targetPoints[b][1],q/2,0,2*Math.PI,!1),j.stroke();if(e[0]/=4,e[1]/=4,c){var f=k[a].element.id.toUpperCase();j.font="16px sans-serif",j.textAlign="center";var g=j.measureText(f),h=[g.width+8,32];j.fillStyle="white",j.fillRect(e[0]-h[0]/2,e[1]-h[1]+8,h[0],h[1]),j.fillStyle="black",j.fillText(f,e[0],e[1])}}d&&(j.strokeStyle="yellow",j.lineWidth="1px",j.beginPath(),j.moveTo(t[0],0),j.lineTo(t[0],i.height),j.moveTo(0,t[1]),j.lineTo(i.width,t[1]),j.stroke())}},A=function(){i=document.createElement("canvas"),i.style.display="none",i.style.position="fixed",i.style.top="0px",i.style.left="0px",i.style.zIndex="1000000",j=i.getContext("2d"),document.body.appendChild(i),window.addEventListener("resize",L),window.addEventListener("mousemove",C),window.addEventListener("mouseup",D),window.addEventListener("mousedown",E),window.addEventListener("keydown",B),L()},B=function(a){if(!l)return 32==a.keyCode&&a.shiftKey?void J(!0):void 0;var b=a.keyCode,c=a.shiftKey?10:1,f=!1,g=[0,0];switch(b){case 32:if(a.shiftKey)return void J(!1);break;case 37:g[0]-=c;break;case 38:g[1]-=c;break;case 39:g[0]+=c;break;case 40:g[1]+=c;break;case 67:d=!d,f=!0;break;case 83:m=!1,f=!0}if(p)p[0]+=g[0],p[1]+=g[1],f=!0;else if(o){for(var h=0;h<o.targetPoints.length;h++)o.targetPoints[h][0]+=g[0],o.targetPoints[h][1]+=g[1];f=!0}f&&(I(),z(),e&&G(),y())},C=function(a){if(l)if(a.preventDefault(),u[0]=a.clientX-t[0],u[1]=a.clientY-t[1],t[0]=a.clientX,t[1]=a.clientY,m){var b=a.shiftKey?.1:1;if(p)p[0]+=u[0]*b,p[1]+=u[1]*b;else if(o)for(var c=0;c<o.targetPoints.length;c++)o.targetPoints[c][0]+=u[0]*b,o.targetPoints[c][1]+=u[1]*b;I(),e&&G(),z(),y()}else{i.style.cursor="default";var f=a.clientX,g=a.clientY,h=null!=r,j=null!=s;r=null;for(var c=0;c<k.length;c++)for(var n=k[c],w=0;w<n.targetPoints.length;w++){var A=n.targetPoints[w];if(v(A[0],A[1],f,g)<q){i.style.cursor="pointer",r=A;break}}s=null;for(var c=0;c<k.length;c++)if(x(t,k[c])){s=k[c];break}(d||h!=(null!=r)||j!=(null!=s))&&z()}},D=function(a){l&&(a.preventDefault(),m=!1)},E=function(a){if(l){a.preventDefault(),r=null,s?(o=s,m=!0):o=null,p=null;for(var b=a.clientX,c=a.clientY,d=0;d<k.length;d++)for(var e=k[d],f=0;f<e.targetPoints.length;f++){var g=e.targetPoints[f];if(v(g[0],g[1],b,c)<q){o=e,p=g,m=!0,n[0]=a.clientX-g[0],n[1]=a.clientY-g[1];break}}return z(),!1}},F=function(a,b){var c;if("string"==typeof a){if(c=document.getElementById(a),!c)throw"Maptastic: No element found with id: "+a}else a instanceof HTMLElement&&(c=a);for(var d=!1,e=0;e<k.length;e++)k[e].element.id==c.id&&(k[e].targetPoints=K(layout[i].targetPoints),d=!0);var f=c.offsetLeft,g=c.offsetTop;c.style.position="absolute",c.style.display="block",c.style.top="0px",c.style.left="0px",c.style.padding="0px",c.style.margin="0px";var h={element:c,width:c.clientWidth,height:c.clientHeight,sourcePoints:[],targetPoints:[]};if(h.sourcePoints.push([0,0],[h.width,0],[h.width,h.height],[0,h.height]),b)h.targetPoints=K(b);else{h.targetPoints.push([0,0],[h.width,0],[h.width,h.height],[0,h.height]);for(var i=0;i<h.targetPoints.length;i++)h.targetPoints[i][0]+=f,h.targetPoints[i][1]+=g}k.push(h),I()},G=function(){localStorage.setItem(h,JSON.stringify(M(k)))},H=function(){if(localStorage.getItem(h)){for(var a=JSON.parse(localStorage.getItem(h)),b=0;b<a.length;b++)for(var c=0;c<k.length;c++)k[c].element.id==a[b].id&&(k[c].targetPoints=K(a[b].targetPoints));I()}},I=function(){for(var a=(["","-webkit-","-moz-","-ms-","-o-"].reduce(function(a,b){return b+"transform"in document.body.style?b:a})+"transform"),b=0;b<k.length;b++){for(var c=[],d=[],e=0,f=k[b].sourcePoints.length;f>e;++e){var g=k[b].sourcePoints[e],h=k[b].targetPoints[e];c.push([g[0],g[1],1,0,0,0,-g[0]*h[0],-g[1]*h[0]]),d.push(h[0]),c.push([0,0,0,g[0],g[1],1,-g[0]*h[1],-g[1]*h[1]]),d.push(h[1])}var i=solve(c,d,!0),j=[i[0],i[3],0,i[6],i[1],i[4],0,i[7],0,0,1,0,i[2],i[5],0,1];k[b].element.style[a]="matrix3d("+j.join(",")+")",k[b].element.style[a+"-origin"]="0px 0px 0px"}},J=function(a){l=a,i.style.display=a?"block":"none",a?z():(p=null,o=null,m=!1)},K=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].slice(0,2));return b},L=function(){viewWidth=window.innerWidth,viewHeight=window.innerHeight,i.width=window.innerWidth,i.height=window.innerHeight,z()},M=function(){for(var a=[],b=0;b<k.length;b++)a.push({id:k[b].element.id,targetPoints:K(k[b].targetPoints)});return a},N=function(a){for(var b=0;b<a.length;b++){for(var c=!1,d=0;d<k.length;d++)k[d].element.id==a[b].id&&(console.log("Setting points."),k[d].targetPoints=K(a[b].targetPoints),c=!0);if(c)console.log("Maptastic: Element '"+a[b].id+"' is already mapped.");else{var e=document.getElementById(a[b].id);e?F(e,a[b].targetPoints):console.log("Maptastic: Can't find element: "+a[b].id)}}I(),z()};A();for(var O=0;O<f.length;O++)(f[O]instanceof HTMLElement||"string"==typeof f[O])&&F(f[O]);for(var O=0;O<arguments.length;O++)(arguments[O]instanceof HTMLElement||"string"==typeof arguments[O])&&F(arguments[O]);return{getLayout:function(){return M()},setLayout:function(a){N(a)},setConfigEnabled:function(a){J(a)},addLayer:function(a,b){F(a,b)},saveLayout:function(){G()},loadLayout:function(){H()}}};